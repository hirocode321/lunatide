{% extends "base.html" %}

{% block title %}初心者向け撮影ガイド - LunaTide{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-5 text-center">
        <div class="col-12">
            <h1 class="display-4 fw-bold text-white mb-3">Beginner's Photo Guide</h1>
            <p class="lead text-light">夜空の美しさを、あなたのカメラで。初心者のための撮影ガイドです。</p>
        </div>
    </div>

    <!-- Features Navigation -->
    <ul class="nav nav-pills nav-fill mb-4 bg-dark p-2 rounded shadow-sm sticky-top" style="top: 10px; z-index: 1020;"
        id="guideTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="calc-tab" data-bs-toggle="tab" data-bs-target="#calc-pane" type="button"
                role="tab"><i class="fas fa-calculator me-2"></i>露出計算</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="check-tab" data-bs-toggle="tab" data-bs-target="#check-pane" type="button"
                role="tab"><i class="fas fa-list-check me-2"></i>持ち物</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="focus-tab" data-bs-toggle="tab" data-bs-target="#focus-pane" type="button"
                role="tab"><i class="fas fa-crosshairs me-2"></i>ピント合わせ</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="location-tab" data-bs-toggle="tab" data-bs-target="#location-pane"
                type="button" role="tab"><i class="fas fa-map-location-dot me-2"></i>場所選び</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="etiquette-tab" data-bs-toggle="tab" data-bs-target="#etiquette-pane"
                type="button" role="tab"><i class="fas fa-user-shield me-2"></i>マナー・安全</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="weather-guide-tab" data-bs-toggle="tab" data-bs-target="#weather-guide-pane"
                type="button" role="tab"><i class="fas fa-cloud-sun me-2"></i>気象条件</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-pane"
                type="button" role="tab"><i class="fas fa-cogs me-2"></i>設定の目安</button>
        </li>
    </ul>

    <div class="tab-content border-0" id="guideTabContent">
        <!-- 1. Exposure Calculator -->
        <div class="tab-pane fade show active" id="calc-pane" role="tabpanel" tabindex="0">
            <div class="card bg-dark text-white border-secondary shadow">
                <div class="card-body p-4">
                    <h2 class="h3 mb-4"><i class="fas fa-calculator text-primary me-2"></i>星を点に写す：露出計算機</h2>
                    <p class="text-secondary small mb-4">
                        星はゆっくりと動いているため、シャッタースピードが長すぎると線のように伸びてしまいます。星を点として写すための限界時間を計算します（Nルール）。</p>

                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="focalLength" class="form-label">レンズの焦点距離 (mm)</label>
                            <input type="number" class="form-control bg-secondary text-white border-0" id="focalLength"
                                placeholder="例: 14" value="24">
                        </div>
                        <div class="col-md-4">
                            <label for="sensorType" class="form-label">センサーサイズ</label>
                            <select class="form-select bg-secondary text-white border-0" id="sensorType">
                                <option value="1">フルサイズ (1.0x)</option>
                                <option value="1.5">APS-C (1.5x - Sony, Nikon, Fuji)</option>
                                <option value="1.6">APS-C (1.6x - Canon)</option>
                                <option value="2">マイクロフォーサーズ (2.0x)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="ruleType" class="form-label">計算ルール</label>
                            <select class="form-select bg-secondary text-white border-0" id="ruleType">
                                <option value="200">200ルール (厳格)</option>
                                <option value="300" selected>300ルール (標準)</option>
                                <option value="500">500ルール (許容)</option>
                            </select>
                        </div>
                    </div>

                    <div class="mt-4 p-4 bg-black rounded text-center border border-primary">
                        <h3 class="h6 text-uppercase text-secondary mb-2">おすすめのシャッタースピード</h3>
                        <div class="display-2 fw-bold text-primary" id="calcResult">21</div>
                        <p class="text-light mt-2">秒 以下</p>
                    </div>

                    <hr class="border-secondary my-4">

                    <h3 class="h5 text-info mb-3"><i class="fas fa-save me-2"></i>マイ機材プロファイル</h3>
                    <div class="bg-secondary bg-opacity-10 p-3 rounded border border-secondary">
                        <div class="mb-3">
                            <label for="profileNotes" class="form-label small text-muted">機材メモ・プリセット設定 (例: ISO 3200,
                                F2.8)</label>
                            <textarea class="form-control bg-dark text-white border-secondary" id="profileNotes"
                                rows="2" placeholder="自分のよく使う設定やカメラ・レンズ名をメモしておけます"></textarea>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <button id="saveProfileBtn" class="btn btn-outline-primary btn-sm px-4 rounded-pill"><i
                                    class="fas fa-check me-2"></i>この設定を保存</button>
                            <span id="saveStatus" class="text-success small fw-bold" style="display: none;"><i
                                    class="fas fa-check-circle me-1"></i>保存しました！</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. Equipment Checklist -->
        <div class="tab-pane fade" id="check-pane" role="tabpanel" tabindex="0">
            <div class="card bg-dark text-white border-secondary shadow">
                <div class="card-body p-4">
                    <h2 class="h3 mb-4"><i class="fas fa-list-check text-success me-2"></i>撮影の持ち物チェックリスト</h2>
                    <div class="row g-4">
                        <div class="col-md-6">
                            <h4 class="h5 text-primary">必須アイテム</h4>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="item1">
                                <label class="form-check-label" for="item1">カメラ (マニュアル撮影ができるもの)</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="item2">
                                <label class="form-check-label" for="item2">広角レンズ (F値が小さいほど良い)</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="item3">
                                <label class="form-check-label" for="item3">三脚 (しっかり固定できるもの)</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="item4">
                                <label class="form-check-label" for="item4">予備バッテリー & SDカード</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h4 class="h5 text-warning">あると便利なもの</h4>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="item5">
                                <label class="form-check-label" for="item5">レリーズ (または2秒セルフタイマー)</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="item6">
                                <label class="form-check-label" for="item6">赤いライト (暗闇に目が慣れるのを防ぐ)</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="item7">
                                <label class="form-check-label" for="item7">防寒着 (夜は想像以上に冷えます)</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="item8">
                                <label class="form-check-label" for="item8">モバイルバッテリー</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. Focus Guide -->
        <div class="tab-pane fade" id="focus-pane" role="tabpanel" tabindex="0">
            <div class="card bg-dark text-white border-secondary shadow">
                <div class="card-body p-4">
                    <h2 class="h3 mb-4"><i class="fas fa-crosshairs text-info me-2"></i>星にピントを合わせるコツ</h2>
                    <div class="timeline">
                        <div class="mb-4">
                            <h4 class="text-info">1. マニュアルフォーカス(MF)にする</h4>
                            <p>星は暗すぎるため、オートフォーカスは効きません。レンズのスイッチを必ずMFに切り替えましょう。</p>
                        </div>
                        <div class="mb-4">
                            <h4 class="text-info">2. 明るい星を探す</h4>
                            <p>ライブビュー画面で、できるだけ明るい星を画面の中央に配置します。</p>
                        </div>
                        <div class="mb-4">
                            <h4 class="text-info">3. 画面を最大まで拡大する</h4>
                            <p>拡大表示機能（虫眼鏡アイコンなど）を使い、星を大きく映し出します。</p>
                        </div>
                        <div class="mb-4">
                            <h4 class="text-info">4. 星が一番小さくなる位置を探す</h4>
                            <p>フォーカスリングをゆっくり回し、星の光の点が「最も小さく、ハッキリした点」になる場所を見つけます。それがピントの合った状態です。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. Location & Light Pollution -->
        <div class="tab-pane fade" id="location-pane" role="tabpanel" tabindex="0">
            <div class="card bg-dark text-white border-secondary shadow">
                <div class="card-body p-4">
                    <h2 class="h3 mb-4"><i class="fas fa-map-location-dot text-primary me-2"></i>最高の空を探す：場所選びと光害</h2>
                    <p class="text-secondary mb-4">星を綺麗に撮るための最も重要な要素は「機材」ではなく「場所」です。</p>

                    <div class="row g-4">
                        <div class="col-md-6">
                            <h4 class="h5 text-primary">ボートル・スケール (Bortle Scale)</h4>
                            <p class="small text-light">空の暗さを1〜9のランクで表す指標です。</p>
                            <ul class="list-unstyled small">
                                <li class="mb-2"><span class="badge bg-success me-2">Class 1-2</span>
                                    最高の暗さ。天の川が影を作るほど明るく見えます。</li>
                                <li class="mb-2"><span class="badge bg-info me-2">Class 3-4</span> 田舎の空。天の川の構造がはっきり見えます。
                                </li>
                                <li class="mb-2"><span class="badge bg-warning text-dark me-2">Class 5-6</span>
                                    郊外の空。天の川はぼんやりと見えます。</li>
                                <li class="mb-2"><span class="badge bg-danger me-2">Class 7-9</span> 都市部の空。明るい星しか見えません。
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h4 class="h5 text-primary">場所選びのポイント</h4>
                            <div class="bg-black p-3 rounded border border-secondary mb-3">
                                <ul class="mb-0 small">
                                    <li><strong>光害マップを活用：</strong> 「Light Pollution Map」などのサイトで、青や黒のエリアを探しましょう。</li>
                                    <li><strong>視界の開けた場所：</strong> 特に撮りたい対象（天の川など）がある方角が開けているか確認。</li>
                                    <li><strong>標高が高い場所：</strong> 空気の色収差や霞が少なく、よりクリアに写ります。</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 6. Etiquette & Safety -->
        <div class="tab-pane fade" id="etiquette-pane" role="tabpanel" tabindex="0">
            <div class="card bg-dark text-white border-secondary shadow">
                <div class="card-body p-4">
                    <h2 class="h3 mb-4"><i class="fas fa-user-shield text-warning me-2"></i>撮影のマナーと安全</h2>
                    <div class="row g-4">
                        <div class="col-md-6">
                            <h4 class="h5 text-warning">暗闇でのマナー</h4>
                            <ul class="small">
                                <li class="mb-2"><strong>赤いライトの使用：</strong>
                                    白い光は人間の目を眩ませ、撮影中の他人の写真にも台無しにします。赤いライトなら夜間視力を維持できます。</li>
                                <li class="mb-2"><strong>スマホ画面に注意：</strong> スマホの画面も非常に明るいです。使うときは明るさを最小にするか、背を向けましょう。
                                </li>
                                <li class="mb-2"><strong>静かに過ごす：</strong> 星空スポットは閑静な場所が多いです。深夜の大きな話し声や車のエンジン音には配慮しましょう。
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h4 class="h5 text-warning">安全を守るために</h4>
                            <div class="alert alert-warning bg-opacity-10 border-warning text-warning small">
                                <i class="fas fa-exclamation-triangle me-2"></i><strong>注意：</strong> 夜間の撮影は危険を伴います。
                                <ul class="mt-2 mb-0">
                                    <li>家族や友人に目的地を伝えておく。</li>
                                    <li>防寒対策は「やりすぎ」なくらいが丁度いい（夜は急冷します）。</li>
                                    <li>野生動物（クマ、イノシシなど）への対策を。</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 7. Weather Conditions -->
        <div class="tab-pane fade" id="weather-guide-pane" role="tabpanel" tabindex="0">
            <div class="card bg-dark text-white border-secondary shadow">
                <div class="card-body p-4">
                    <h2 class="h3 mb-4"><i class="fas fa-cloud-sun text-info me-2"></i>気象条件のチェック</h2>
                    <div class="row g-4">
                        <div class="col-md-4">
                            <div class="text-center mb-3">
                                <i class="fas fa-cloud fa-3x text-secondary mb-2"></i>
                                <h5 class="text-info">雲量</h5>
                            </div>
                            <p class="small text-muted">当然ですが、快晴がベスト。低層・中層・高層の雲の状態を詳しく見られる予報サイト（SCWなど）が便利です。</p>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center mb-3">
                                <i class="fas fa-droplet fa-3x text-primary mb-2"></i>
                                <h5 class="text-info">湿度と夜露</h5>
                            </div>
                            <p class="small text-muted">湿度が高いとレンズが曇ります。レンズヒーターや、使い捨てカイロを巻き付ける対策が必須になることがあります。</p>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center mb-3">
                                <i class="fas fa-wind fa-3x text-warning mb-2"></i>
                                <h5 class="text-info">風の影響</h5>
                            </div>
                            <p class="small text-muted">長秒露光では、わずかな風でも三脚が揺れて星がブレます。風の強い日は三脚を低くく、重しを付けるなどの工夫が必要です。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. Settings Cheat Sheet -->
        <div class="tab-pane fade" id="settings-pane" role="tabpanel" tabindex="0">
            <div class="card bg-dark text-white border-secondary shadow">
                <div class="card-body p-4">
                    <h2 class="h3 mb-4"><i class="fas fa-cogs text-warning me-2"></i>被写体別・設定の目安</h2>
                    <div class="table-responsive">
                        <table class="table table-dark table-hover border-secondary">
                            <thead>
                                <tr class="text-primary">
                                    <th>被写体</th>
                                    <th>絞り (F値)</th>
                                    <th>ISO感度</th>
                                    <th>露出時間</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>天の川・満天の星</td>
                                    <td>開放 (F2.8以下推奨)</td>
                                    <td>1600 - 6400</td>
                                    <td>15 - 25秒</td>
                                </tr>
                                <tr>
                                    <td>月 (月齢による)</td>
                                    <td>F8 - F11</td>
                                    <td>100 - 400</td>
                                    <td>1/100 - 1/500秒</td>
                                </tr>
                                <tr>
                                    <td>流星群</td>
                                    <td>開放 (最も明るい値)</td>
                                    <td>3200以上</td>
                                    <td>10 - 20秒 (連写)</td>
                                </tr>
                                <tr>
                                    <td>星の軌跡 (比較明合成)</td>
                                    <td>F4 - F5.6</td>
                                    <td>400 - 1600</td>
                                    <td>20 - 30秒 (多数撮影)</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="alert alert-info bg-opacity-10 border-info text-info mt-3">
                        <i class="fas fa-lightbulb me-2"></i><strong>Tip:</strong> RAW形式の保存を忘れずに！後で明るさや色味を調整しやすくなります。
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recommendation Section -->
    <div class="row mt-5">
        <div class="col-12 text-center">
            <h3 class="text-white mb-4">撮影の計画を立てよう</h3>
            <div class="d-flex justify-content-center gap-3">
                <a href="{{ url_for('main.index') }}" class="btn btn-outline-light btn-lg px-4"><i
                        class="fas fa-calendar-alt me-2"></i>カレンダーを見る</a>
                <a href="{{ url_for('astro.astro') }}" class="btn btn-primary btn-lg px-4"><i
                        class="fas fa-star me-2"></i>天文イベントを探す</a>
            </div>
        </div>
    </div>
</div>

<style>
    #guideTabs .nav-link {
        color: #adb5bd;
        transition: all 0.3s;
        border-radius: 8px;
        margin: 0 5px;
    }

    #guideTabs .nav-link.active {
        background-color: #3d5afe;
        color: white;
    }

    #guideTabs .nav-link:hover:not(.active) {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .card {
        border-radius: 15px;
        background: linear-gradient(145deg, #161b22, #0d1117);
    }

    .form-control,
    .form-select {
        border-radius: 8px;
        padding: 12px;
    }

    .timeline {
        border-left: 2px solid #3d5afe;
        padding-left: 30px;
        margin-left: 10px;
        position: relative;
    }

    .timeline>div::before {
        content: '';
        position: absolute;
        left: -9px;
        width: 16px;
        height: 16px;
        background: #3d5afe;
        border-radius: 50%;
        margin-top: 5px;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const focalInput = document.getElementById('focalLength');
        const sensorSelect = document.getElementById('sensorType');
        const ruleSelect = document.getElementById('ruleType');
        const resultDisplay = document.getElementById('calcResult');

        const profileNotes = document.getElementById('profileNotes');
        const saveProfileBtn = document.getElementById('saveProfileBtn');
        const saveStatus = document.getElementById('saveStatus');

        function calculateExposure() {
            const focalLength = parseFloat(focalInput.value);
            const cropFactor = parseFloat(sensorSelect.value);
            const ruleValue = parseFloat(ruleSelect.value);

            if (focalLength > 0) {
                // N Rule: Shutter Speed = Rule / (Focal Length * Crop Factor)
                const limit = ruleValue / (focalLength * cropFactor);
                resultDisplay.innerText = Math.floor(limit);
            } else {
                resultDisplay.innerText = '-';
            }
        }

        // Load profile from localStorage
        function loadProfile() {
            const savedFocal = localStorage.getItem('lunaTideFocalLength');
            const savedSensor = localStorage.getItem('lunaTideSensorType');
            const savedRule = localStorage.getItem('lunaTideRuleType');
            const savedNotes = localStorage.getItem('lunaTideProfileNotes');

            if (savedFocal) focalInput.value = savedFocal;
            if (savedSensor) sensorSelect.value = savedSensor;
            if (savedRule) ruleSelect.value = savedRule;
            if (savedNotes) profileNotes.value = savedNotes;
        }

        // Save profile to localStorage
        saveProfileBtn.addEventListener('click', function () {
            localStorage.setItem('lunaTideFocalLength', focalInput.value);
            localStorage.setItem('lunaTideSensorType', sensorSelect.value);
            localStorage.setItem('lunaTideRuleType', ruleSelect.value);
            localStorage.setItem('lunaTideProfileNotes', profileNotes.value);

            saveStatus.style.display = 'inline';
            setTimeout(() => { saveStatus.style.display = 'none'; }, 2000);
        });

        focalInput.addEventListener('input', calculateExposure);
        sensorSelect.addEventListener('change', calculateExposure);
        ruleSelect.addEventListener('change', calculateExposure);

        // Initial process
        loadProfile();
        calculateExposure();
    });
</script>
{% endblock %}