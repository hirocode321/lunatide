{% extends "base.html" %}

{% block title %}観測スポットログ＆光害マップ - LunaTide{% endblock %}

{% block content %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

<style>
    #map {
        height: 60vh;
        width: 100%;
        border-radius: 15px;
        border: 2px solid #3d5afe;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }

    .leaflet-popup-content-wrapper {
        background-color: #1a1f26;
        color: #fff;
        border-radius: 10px;
    }

    .leaflet-popup-tip {
        background-color: #1a1f26;
    }

    .spot-card {
        transition: transform 0.2s;
        cursor: pointer;
    }

    .spot-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(61, 90, 254, 0.3) !important;
    }

    .iss-pulse {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 20px;
        height: 20px;
        background: rgba(77, 182, 172, 0.4);
        border-radius: 50%;
        animation: iss-pulsate 2s infinite;
        z-index: -1;
    }

    @keyframes iss-pulsate {
        0% {
            transform: translate(-50%, -50%) scale(0.5);
            opacity: 1;
        }

        100% {
            transform: translate(-50%, -50%) scale(2.5);
            opacity: 0;
        }
    }
</style>

<div class="container my-5 fade-in">
    <div class="row mb-4 align-items-center">
        <div class="col-md-8">
            <h1 class="display-5 fw-bold"><i class="fas fa-map-marked-alt text-primary me-3"></i>観測スポットログ</h1>
            <p class="text-secondary lead">あなただけのお気に入り観測地を地図に記録し、管理しましょう。</p>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
            <button class="btn btn-outline-primary rounded-pill px-4" data-bs-toggle="modal"
                data-bs-target="#addSpotModal">
                <i class="fas fa-plus me-2"></i>新しいスポットを登録
            </button>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-lg-8">
            <div id="map" class="position-relative z-0"></div>
            <div class="mt-3 text-secondary small text-center">
                <i class="fas fa-info-circle me-1"></i>地図上のベースレイヤーには暗めのスタイルを適用しています。(実際の光害マップ機能は現在モックとして表示しています)
            </div>
        </div>

        <div class="col-lg-4">
            <h3 class="h5 border-bottom border-secondary pb-2 mb-3">マイ・スポット一覧</h3>
            <div class="spots-list overflow-auto" style="max-height: 60vh; padding-right: 5px;">
                {% for spot in spots %}
                <div class="card bg-dark border-secondary mb-3 spot-card"
                    onclick="panToSpot({{ spot.lat }}, {{ spot.lng }}, {{ spot.id }})">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="card-title text-light mb-0">{{ spot.name }}</h5>
                            <span class="badge bg-warning text-dark"><i class="fas fa-star me-1"></i>{{ spot.rating
                                }}</span>
                        </div>
                        <p class="card-text text-secondary small mb-2">{{ spot.note }}</p>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <span
                                class="badge {% if spot.bortle <= 3 %}bg-success{% elif spot.bortle <= 5 %}bg-info{% else %}bg-danger{% endif %} tooltip-element"
                                data-bs-toggle="tooltip" title="夜空の暗さの指標 (1〜9)。数値が低いほど暗い。">
                                Bortle Class: {{ spot.bortle }}
                            </span>
                            <span class="text-muted" style="font-size: 0.7rem;"><i
                                    class="fas fa-location-arrow me-1"></i>{{ "%.2f"|format(spot.lat) }}, {{
                                "%.2f"|format(spot.lng) }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Weather & Astro Details Modal -->
<div class="modal fade" id="weatherModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered border-secondary shadow-lg">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="weatherModalTitle"><i class="fas fa-star text-primary me-2"></i>スポット詳細情報
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="d-flex justify-content-center align-items-center mb-3">
                    <input type="date" id="weatherDate"
                        class="form-control bg-secondary text-white border-0 w-auto me-2" value="{{ today }}">
                    <button class="btn btn-outline-light" onclick="fetchWeatherDetails()">情報を更新</button>
                </div>

                <div id="weatherLoading" class="my-4 d-none">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-secondary">データを取得中...</p>
                </div>
                <div id="weatherError" class="alert alert-danger d-none">データを取得できませんでした。</div>

                <!-- 天気・天文情報エリア -->
                <div id="spotWeatherInfo" class="row g-2 mb-3 d-none text-start">
                    <div class="col-6 col-md-3">
                        <div class="p-2 border border-secondary rounded h-100 bg-secondary bg-opacity-25">
                            <div class="text-secondary small mb-1"><i class="fas fa-cloud me-1"></i>21時の天気</div>
                            <div class="fw-bold" id="swWeather">-</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="p-2 border border-secondary rounded h-100 bg-secondary bg-opacity-25">
                            <div class="text-secondary small mb-1"><i class="fas fa-star me-1"></i>星空指数</div>
                            <div class="fw-bold" id="swStarry">-</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="p-2 border border-secondary rounded h-100 bg-secondary bg-opacity-25">
                            <div class="text-secondary small mb-1"><i class="fas fa-sun text-warning me-1"></i>日の出/入
                            </div>
                            <div class="small fw-bold" id="swSun">-</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="p-2 border border-secondary rounded h-100 bg-secondary bg-opacity-25">
                            <div class="text-secondary small mb-1"><i class="fas fa-moon text-info me-1"></i>月の出/入</div>
                            <div class="small fw-bold" id="swMoon">-</div>
                        </div>
                    </div>
                </div>

                <!-- 星空アドバイスと時系列表示 -->
                <div id="starryAdviceArea" class="mb-4 d-none text-start">
                    <div class="p-3 rounded bg-opacity-10 bg-info border border-info border-opacity-25 mb-3">
                        <p class="mb-0 fw-bold text-info small" id="starrySuggestion">
                            <i class="fas fa-magic me-2"></i>--
                        </p>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary w-100 border-secondary border-opacity-50 text-light"
                        type="button" data-bs-toggle="collapse" data-bs-target="#hourlyBreakdown" aria-expanded="false">
                        <i class="fas fa-chevron-down me-1"></i> 今夜の時系列データを表示
                    </button>
                    <div class="collapse mt-2" id="hourlyBreakdown">
                        <div class="card card-body bg-dark border-secondary p-0 overflow-hidden"
                            style="max-height: 250px; overflow-y: auto;">
                            <div class="list-group list-group-flush" id="hourlyWeatherList">
                                <!-- JSで動的に追加 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Spot Modal -->
<div class="modal fade" id="addSpotModal" tabindex="-1" aria-labelledby="addSpotModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered border-secondary shadow-lg">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="addSpotModalLabel"><i
                        class="fas fa-map-marker-alt text-primary me-2"></i>新しいスポットを登録</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addSpotForm">
                    <div class="mb-3">
                        <label class="form-label">スポット名 <span class="text-danger">*</span></label>
                        <input type="text" id="spotName" class="form-control bg-secondary text-white border-0"
                            placeholder="例: 〇〇高原" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">緯度 (Latitude)</label>
                            <input type="text" id="spotLat" class="form-control bg-secondary text-white border-0"
                                placeholder="35.000" readonly>
                        </div>
                        <div class="col-6">
                            <label class="form-label">経度 (Longitude)</label>
                            <input type="text" id="spotLng" class="form-control bg-secondary text-white border-0"
                                placeholder="135.000" readonly>
                        </div>
                        <div class="mt-1 small text-secondary">
                            <i class="fas fa-info-circle me-1"></i>地図上を直接クリックして場所を指定することもできます。
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">評価</label>
                        <select id="spotRating" class="form-select bg-secondary text-white border-0">
                            <option value="5">⭐⭐⭐⭐⭐ (最高)</option>
                            <option value="4">⭐⭐⭐⭐</option>
                            <option value="3" selected>⭐⭐⭐ (普通)</option>
                            <option value="2">⭐⭐</option>
                            <option value="1">⭐</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">メモ・環境</label>
                        <textarea id="spotNote" class="form-control bg-secondary text-white border-0" rows="3"
                            placeholder="トイレの有無、駐車場の広さなど"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">現地の写真（任意）</label>
                        <input type="file" id="spotImage" class="form-control bg-secondary text-white border-0"
                            accept="image/*">
                    </div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="submitSpot()">登録する</button>
            </div>
        </div>
    </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    // Initialize map, set view to central Japan
    const map = L.map('map').setView([35.5, 138.0], 6);

    // Dark theme map tiles (CartoDB Dark Matter)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 20
    }).addTo(map);

    // Provide spots data from python
    const spots = {{ spots | tojson }};
    const markers = {};

    // Custom star icon
    const starIcon = L.divIcon({
        html: '<i class="fas fa-star fa-lg text-warning" style="filter: drop-shadow(0 0 5px rgba(255,193,7,0.8));"></i>',
        className: 'custom-leaflet-icon',
        iconSize: [20, 20],
        iconAnchor: [10, 10],
        popupAnchor: [0, -10]
    });

    // Add markers
    spots.forEach(spot => {
        const marker = L.marker([spot.lat, spot.lng], { icon: starIcon }).addTo(map);
        let popupContent = `
            <div class="text-center p-1" style="min-width: 150px;">
                <h6 class="mb-1 fw-bold border-bottom border-secondary pb-1">${spot.name}</h6>
                ${spot.thumbnail ? `<img src="/static/uploads/observation_spots/${spot.thumbnail}" class="img-fluid rounded mb-2" style="max-height: 100px; width: 100%; object-fit: cover;">` : ''}
                <div class="small text-warning mb-2"><i class="fas fa-star"></i> ${spot.rating}/5 (Bortle: ${spot.bortle})</div>
                <div class="d-flex justify-content-center gap-1 mb-1">
                    <button class="btn btn-sm btn-primary py-1 px-2 rounded-pill" onclick="showWeatherModal(${spot.lat}, ${spot.lng}, '${spot.name}', ${spot.id})">
                        <i class="fas fa-cloud-moon"></i> 詳細と天気
                    </button>
                </div>
                <p class="small mb-0 opacity-75">${spot.note}</p>
            </div>
        `;
        marker.bindPopup(popupContent);
        markers[spot.id] = marker;
    });

    // Map click event for adding new spot
    let tempMarker = null;
    let addSpotModal = null;

    document.addEventListener('DOMContentLoaded', function () {
        addSpotModal = new bootstrap.Modal(document.getElementById('addSpotModal'));
    });

    map.on('click', function (e) {
        if (tempMarker) map.removeLayer(tempMarker);

        const lat = e.latlng.lat;
        const lng = e.latlng.lng;

        tempMarker = L.marker([lat, lng], {
            icon: L.divIcon({
                html: '<i class="fas fa-map-pin fa-2x text-warning pulse-anim"></i>',
                className: 'custom-leaflet-icon',
                iconAnchor: [12, 24]
            })
        }).addTo(map);

        document.getElementById('spotLat').value = lat.toFixed(5);
        document.getElementById('spotLng').value = lng.toFixed(5);
        document.getElementById('spotName').value = '';
        document.getElementById('spotNote').value = '';
        document.getElementById('spotImage').value = '';

        if (addSpotModal) addSpotModal.show();
    });

    // Submit new spot
    window.submitSpot = function () {
        const name = document.getElementById('spotName').value.trim();
        const lat = document.getElementById('spotLat').value;
        const lng = document.getElementById('spotLng').value;
        const note = document.getElementById('spotNote').value;
        const rating = document.getElementById('spotRating').value;
        const imageFile = document.getElementById('spotImage').files[0];

        if (!name) {
            alert('スポット名は必須です。');
            return;
        }
        if (!lat || !lng) {
            alert('緯度経度の情報が不足しています。マップをクリックして位置を指定してください。');
            return;
        }

        const formData = new FormData();
        formData.append('name', name);
        formData.append('lat', lat);
        formData.append('lng', lng);
        formData.append('note', note);
        formData.append('rating', rating);
        if (imageFile) {
            formData.append('image', imageFile);
        }

        fetch("/api/spots/add", {
            method: "POST",
            body: formData
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('登録に失敗しました: ' + data.error);
                }
            })
            .catch(err => {
                console.error(err);
                alert('エラーが発生しました。');
            });
    };

    // Function to pan to spot when card is clicked
    window.panToSpot = function (lat, lng, id) {
        map.flyTo([lat, lng], 10, {
            duration: 1.5
        });

        // Open the popup after flying
        setTimeout(() => {
            if (markers[id]) markers[id].openPopup();
        }, 1500);
    };

    // Weather Modal Logic
    let currentSpotLoc = null;
    let weatherModal = null;

    window.showWeatherModal = function (lat, lng, name, id) {
        if (!weatherModal) {
            weatherModal = new bootstrap.Modal(document.getElementById('weatherModal'));
        }
        currentSpotLoc = { lat, lng, name };
        document.getElementById('weatherModalTitle').innerHTML = `<i class="fas fa-star text-primary me-2"></i>${name}の現況`;

        // Close popup if open
        if (markers[id]) markers[id].closePopup();

        weatherModal.show();
        fetchWeatherDetails();
    };

    window.fetchWeatherDetails = function () {
        if (!currentSpotLoc) return;

        const dateStr = document.getElementById('weatherDate').value;
        const loadingEl = document.getElementById('weatherLoading');
        const errorEl = document.getElementById('weatherError');
        const infoEl = document.getElementById('spotWeatherInfo');
        const adviceArea = document.getElementById('starryAdviceArea');

        infoEl.classList.add('d-none');
        adviceArea.classList.add('d-none');
        errorEl.classList.add('d-none');
        loadingEl.classList.remove('d-none');

        fetch(`/api/spots/weather?lat=${currentSpotLoc.lat}&lng=${currentSpotLoc.lng}&date=${dateStr}`)
            .then(res => res.json())
            .then(data => {
                loadingEl.classList.add('d-none');
                if (data.error) {
                    errorEl.textContent = data.error;
                    errorEl.classList.remove('d-none');
                    return;
                }

                // Populate Weather Basics
                if (data.weather) {
                    document.getElementById('swWeather').innerHTML = `<i class="${data.weather.icon_class} me-1"></i>${data.weather.condition}`;

                    let starryColor = 'text-success';
                    if (data.weather.starry_index < 30) starryColor = 'text-danger';
                    else if (data.weather.starry_index < 70) starryColor = 'text-warning';
                    document.getElementById('swStarry').innerHTML = `<span class="${starryColor}">${data.weather.starry_index}</span> / 100`;

                    // Suggestion
                    if (data.weather.suggestion) {
                        document.getElementById('starrySuggestion').innerHTML = `<i class="fas fa-magic me-2"></i>${data.weather.suggestion}`;
                        adviceArea.classList.remove('d-none');
                    }

                    // Hourly List
                    if (data.weather.hourly) {
                        const listEl = document.getElementById('hourlyWeatherList');
                        listEl.innerHTML = '';
                        data.weather.hourly.forEach(h => {
                            // Filter night hours (15:00 to 10:00 next day)
                            if ((h.date === dateStr && h.hour >= 15) || (h.date !== dateStr && h.hour <= 10)) {
                                const barColor = h.starry_index >= 80 ? 'bg-success' : (h.starry_index >= 50 ? 'bg-info' : (h.starry_index >= 30 ? 'bg-warning' : 'bg-danger'));
                                const timeColor = h.hour === 21 ? 'text-primary fw-bold' : 'text-muted';
                                const itemHtml = `
                                    <div class="list-group-item bg-dark text-white border-secondary border-opacity-50 py-1 d-flex justify-content-between align-items-center">
                                        <div style="width: 50px;"><span class="small font-monospace ${timeColor}">${h.time}</span></div>
                                        <div class="flex-grow-1 px-3">
                                            <div class="progress" style="height: 4px; background-color: #222;">
                                                <div class="progress-bar ${barColor}" style="width: ${h.starry_index}%"></div>
                                            </div>
                                        </div>
                                        <div class="text-end" style="width: 80px;">
                                            <i class="${h.icon_class} x-small me-1"></i>
                                            <span class="small font-monospace">${h.starry_index}%</span>
                                        </div>
                                    </div>
                                `;
                                listEl.insertAdjacentHTML('beforeend', itemHtml);
                            }
                        });
                    }
                }

                // Populate Sun/Moon
                if (data.sun) {
                    document.getElementById('swSun').innerHTML = `出: ${data.sun.sunrise}<br>入: ${data.sun.sunset}`;
                }
                if (data.moon) {
                    document.getElementById('swMoon').innerHTML = `出: ${data.moon.moon_rise}<br>入: ${data.moon.moon_set} <span class="ms-1 text-secondary" style="font-size:0.7rem;">(月齢${data.moon.moon_age})</span>`;
                }

                infoEl.classList.remove('d-none');
            })
            .catch(err => {
                loadingEl.classList.add('d-none');
                errorEl.textContent = "通信エラー";
                errorEl.classList.remove('d-none');
            });
    };

    // Initialize tooltips
    document.addEventListener('DOMContentLoaded', function () {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('.tooltip-element'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        // Start ISS tracking
        initISSTracking();
    });

    // ISS Orbit Visualization Logic
    let issTrackLayer = null;
    let issMarker = null;

    function initISSTracking() {
        fetchISSData();
        // Refresh every 5 minutes
        setInterval(fetchISSData, 5 * 60 * 1000);
    }

    function fetchISSData() {
        fetch('/api/iss/track')
            .then(res => res.json())
            .then(data => {
                if (data.error) throw new Error(data.error);
                renderISSTrack(data);
            })
            .catch(err => console.error('ISS Track Error:', err));
    }

    function renderISSTrack(trackData) {
        if (issTrackLayer) map.removeLayer(issTrackLayer);
        if (issMarker) map.removeLayer(issMarker);

        const points = trackData.map(t => [t.lat, t.lng]);

        // Split track at date line to avoid "wrapping" lines across the whole map
        const segments = [];
        let currentSegment = [trackData[0]];

        for (let i = 1; i < trackData.length; i++) {
            const prev = trackData[i - 1];
            const curr = trackData[i];

            // If the longitude jumped by more than 180 deg, it's a wrap
            if (Math.abs(curr.lng - prev.lng) > 180) {
                segments.push(currentSegment);
                currentSegment = [];
            }
            currentSegment.push(curr);
        }
        segments.push(currentSegment);

        const layerGroup = L.layerGroup();

        segments.forEach(seg => {
            const segPoints = seg.map(t => [t.lat, t.lng]);
            // Style based on sunlit status (solid for visible/sunlit, dashed for shadowed)
            // Note: Since a segment might have mixed status, we simplify to the segment's majority or just styling the whole polyline.
            // For better UX, we'll draw one polyline that is dashed overall but has a pulse at the CURRENT position.

            L.polyline(segPoints, {
                color: '#4db6ac',
                weight: 2,
                opacity: 0.6,
                dashArray: '5, 5'
            }).addTo(layerGroup);
        });

        issTrackLayer = layerGroup.addTo(map);

        // Marker for Current position (the first point in trackData is 'now')
        const current = trackData[0];
        const issIcon = L.divIcon({
            html: `
                <div class="iss-container">
                    <i class="fas fa-satellite fa-lg text-info" style="filter: drop-shadow(0 0 5px rgba(77,182,172,0.8));"></i>
                    <div class="iss-pulse"></div>
                </div>
            `,
            className: 'custom-leaflet-icon',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });

        issMarker = L.marker([current.lat, current.lng], { icon: issIcon }).addTo(map);
        issMarker.bindPopup(`
            <div class="text-center p-1">
                <h6 class="mb-1 fw-bold text-info"><i class="fas fa-satellite me-1"></i>ISS (国際宇宙ステーション)</h6>
                <div class="small mb-1">現在地を通過中</div>
                <div class="badge ${current.is_sunlit ? 'bg-success' : 'bg-secondary'} mb-1">
                    ${current.is_sunlit ? '日照あり' : '日陰'}
                </div>
                <div class="x-small opacity-75">${current.lat.toFixed(2)}, ${current.lng.toFixed(2)}</div>
            </div>
        `);
    }
</script>
{% endblock %}