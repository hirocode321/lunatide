{% extends "base.html" %}

{% block title %}観測スポットログ＆光害マップ - LunaTide{% endblock %}

{% block content %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

<style>
    #map {
        height: 60vh;
        width: 100%;
        border-radius: 15px;
        border: 2px solid #3d5afe;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }

    .leaflet-popup-content-wrapper {
        background-color: #1a1f26;
        color: #fff;
        border-radius: 10px;
    }

    .leaflet-popup-tip {
        background-color: #1a1f26;
    }

    .spot-card {
        transition: transform 0.2s;
        cursor: pointer;
    }

    .spot-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(61, 90, 254, 0.3) !important;
    }
</style>

<div class="container my-5 fade-in">
    <div class="row mb-4 align-items-center">
        <div class="col-md-8">
            <h1 class="display-5 fw-bold"><i class="fas fa-map-marked-alt text-primary me-3"></i>観測スポットログ</h1>
            <p class="text-secondary lead">あなただけのお気に入り観測地を地図に記録し、管理しましょう。</p>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
            <button class="btn btn-outline-primary rounded-pill px-4" data-bs-toggle="modal"
                data-bs-target="#addSpotModal">
                <i class="fas fa-plus me-2"></i>新しいスポットを登録
            </button>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-lg-8">
            <div id="map" class="position-relative z-0"></div>
            <div class="mt-3 text-secondary small text-center">
                <i class="fas fa-info-circle me-1"></i>地図上のベースレイヤーには暗めのスタイルを適用しています。(実際の光害マップ機能は現在モックとして表示しています)
            </div>
        </div>

        <div class="col-lg-4">
            <h3 class="h5 border-bottom border-secondary pb-2 mb-3">マイ・スポット一覧</h3>
            <div class="spots-list overflow-auto" style="max-height: 60vh; padding-right: 5px;">
                {% for spot in spots %}
                <div class="card bg-dark border-secondary mb-3 spot-card"
                    onclick="panToSpot({{ spot.lat }}, {{ spot.lng }}, {{ spot.id }})">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="card-title text-light mb-0">{{ spot.name }}</h5>
                            <span class="badge bg-warning text-dark"><i class="fas fa-star me-1"></i>{{ spot.rating
                                }}</span>
                        </div>
                        <p class="card-text text-secondary small mb-2">{{ spot.note }}</p>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <span
                                class="badge {% if spot.bortle <= 3 %}bg-success{% elif spot.bortle <= 5 %}bg-info{% else %}bg-danger{% endif %} tooltip-element"
                                data-bs-toggle="tooltip" title="夜空の暗さの指標 (1〜9)。数値が低いほど暗い。">
                                Bortle Class: {{ spot.bortle }}
                            </span>
                            <span class="text-muted" style="font-size: 0.7rem;"><i
                                    class="fas fa-location-arrow me-1"></i>{{ "%.2f"|format(spot.lat) }}, {{
                                "%.2f"|format(spot.lng) }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Add Spot Modal Mock -->
<div class="modal fade" id="addSpotModal" tabindex="-1" aria-labelledby="addSpotModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered border-secondary shadow-lg">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="addSpotModalLabel"><i
                        class="fas fa-map-marker-alt text-primary me-2"></i>スポットを登録 (モック)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info bg-opacity-10 border-info small">
                    <i class="fas fa-hammer me-2"></i>これは開発中のモック機能です。保存しても実際のデータベースには追加されません。
                </div>
                <div class="mb-3">
                    <label class="form-label">スポット名</label>
                    <input type="text" class="form-control bg-secondary text-white border-0" placeholder="例: 〇〇高原">
                </div>
                <div class="row mb-3">
                    <div class="col-6">
                        <label class="form-label">緯度 (Latitude)</label>
                        <input type="text" class="form-control bg-secondary text-white border-0" placeholder="35.000">
                    </div>
                    <div class="col-6">
                        <label class="form-label">経度 (Longitude)</label>
                        <input type="text" class="form-control bg-secondary text-white border-0" placeholder="135.000">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">メモ・環境</label>
                    <textarea class="form-control bg-secondary text-white border-0" rows="3"
                        placeholder="トイレの有無、駐車場の広さなど"></textarea>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal"
                    onclick="alert('スポットを保存しました！（※モックの動作です）')">保存する</button>
            </div>
        </div>
    </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    // Initialize map, set view to central Japan
    const map = L.map('map').setView([35.5, 138.0], 6);

    // Dark theme map tiles (CartoDB Dark Matter)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 20
    }).addTo(map);

    // Provide spots data from python
    const spots = {{ spots | tojson }};
    const markers = {};

    // Custom star icon
    const starIcon = L.divIcon({
        html: '<i class="fas fa-star fa-lg text-warning" style="filter: drop-shadow(0 0 5px rgba(255,193,7,0.8));"></i>',
        className: 'custom-leaflet-icon',
        iconSize: [20, 20],
        iconAnchor: [10, 10],
        popupAnchor: [0, -10]
    });

    // Add markers
    spots.forEach(spot => {
        const marker = L.marker([spot.lat, spot.lng], { icon: starIcon }).addTo(map);
        marker.bindPopup(`
            <div class="text-center p-1">
                <h6 class="mb-1 fw-bold border-bottom border-secondary pb-1">${spot.name}</h6>
                <div class="small text-warning mb-2"><i class="fas fa-star"></i> ${spot.rating}/5 (Bortle: ${spot.bortle})</div>
                <p class="small mb-0 opacity-75">${spot.note}</p>
            </div>
        `);
        markers[spot.id] = marker;
    });

    // Function to pan to spot when card is clicked
    window.panToSpot = function (lat, lng, id) {
        map.flyTo([lat, lng], 10, {
            duration: 1.5
        });

        // Open the popup after flying
        setTimeout(() => {
            if (markers[id]) markers[id].openPopup();
        }, 1500);
    };

    // Initialize tooltips
    document.addEventListener('DOMContentLoaded', function () {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('.tooltip-element'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
    });
</script>
{% endblock %}