{% extends "base.html" %}

{% block title %}潮の満ち引き{% endblock %}

{% block content %}
    <div class="container mt-4">
        <h1 class="text-center">干潮満潮のグラフ</h1>

        <div id="result" class="mt-4 mb-1 text-center">
            <img id="tide-image" src="" alt="Tide Graph" class="img-fluid d-none">
        </div>

        <form id="tide-form">
            <div class="mb-3">
                <label for="region" class="form-label">地域を選択</label>
                <select id="region" class="form-select" required>
                    <option value="" selected disabled>地域を選択してください</option>
                    {% for region, code in pc_code.items() %}
                        <option value="{{ code }}">{{ region }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label for="port" class="form-label">港を選択</label>
                <select id="port" class="form-select" required>
                    <option value="" selected disabled>まず地域を選択してください</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="date" class="form-label">日付を選択</label>
                <input type="date" id="date" class="form-control" value="{{ today }}" required>
            </div>

            <button type="submit" class="btn btn-primary">表示</button>
        </form>

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script>
            $(document).ready(function() {
                $("#region").change(function() {
                    const pc = $(this).val();
                    $("#port").empty().append('<option value="" disabled selected>Loading...</option>');
                    $.getJSON(`/get_ports/${pc}`, function(data) {
                        $("#port").empty().append('<option value="" disabled selected>港を選択してください</option>');
                        $.each(data, function(key, value) {
                            $("#port").append(`<option value="${key}">${value}</option>`);
                        });
                    });
                });
        
                $("#tide-form").submit(function(e) {
                    e.preventDefault();
                    const pc = $("#region").val();
                    const hc = $("#port").val();
                    const date = $("#date").val();
        
                    if (!pc || !hc || !date) {
                        alert("全てのフィールドを入力してください。");
                        return;
                    }
        
                    $.ajax({
                        url: "/get_image_url",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify({ pc, hc, date }),
                        success: function(data) {
                            if (data.image_url) {
                                $("#tide-image").attr("src", data.image_url).removeClass("d-none");
                            } else {
                                alert("画像URLの生成に失敗しました。");
                            }
                        },
                        error: function() {
                            alert("エラーが発生しました。再試行してください。");
                        }
                    });
                });
            });
        </script>

    </div>
{% endblock %}
