{% extends "base.html" %}

{% block title %}月齢カレンダー{% endblock %}

{% block content %}
<div class="container my-5 calendar-container fade-in">
    <div class="text-center mb-4">
        <h1 class="display-5 font-weight-bold">{{ year }}年{{ month }}月</h1>
        <p class="text-secondary">月齢と星々が織りなす、今月のリズム</p>
    </div>

    <!-- Notifications & Recommendations -->
    <div class="row justify-content-center mb-5">
        <div class="col-md-8">
            {% if tomorrow_event %}
            <div class="alert alert-info border-0 shadow-sm d-flex align-items-center mb-3" role="alert">
                <div class="display-6 me-3"><i class="fas fa-bell"></i></div>
                <div>
                    <h5 class="alert-heading mb-1">明日、注目の天体イベントがあります！</h5>
                    <p class="mb-0">{{ tomorrow_event.title }} ({{ tomorrow_event.iso_date }}) - <a href="{{ url_for('astro.astroinfo', event=tomorrow_event.slug) }}" class="alert-link">詳細を見る</a></p>
                </div>
            </div>
            {% endif %}

            {% if recommendation %}
            <div class="card border-0 shadow-sm {{ recommendation.bg_class or 'bg-light text-dark' }}">
                <div class="card-body d-flex align-items-center">
                    <div class="display-4 me-4 opacity-75"><i class="{{ recommendation.icon }}"></i></div>
                    <div>
                        <h5 class="card-title fw-bold">今日のおすすめ: {{ recommendation.title }}</h5>
                        <p class="card-text mb-0">{{ recommendation.text }}</p>
                        <!-- Visibility Visualization Placeholder -->
                        <div class="mt-2 text-warning">
                            {% if '星空観測に最適' in recommendation.title %}
                            <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i> <span class="text-white small ms-1">観測好機</span>
                            {% elif '三日月' in recommendation.title %}
                            <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="far fa-star"></i><i class="far fa-star"></i>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="{{ url_for('main.index', year=prev_year, month=prev_month) }}" class="btn btn-outline-light px-4">
            <i class="fas fa-chevron-left me-2"></i>前月
        </a>
        <div class="h4 mb-0 text-primary font-monospace">{{ year }}.{{ month }}</div>
        <a href="{{ url_for('main.index', year=next_year, month=next_month) }}" class="btn btn-outline-light px-4">
            次月<i class="fas fa-chevron-right ms-2"></i>
        </a>
    </div>

    <div class="calendar-grid">
        <!-- Weekday Headers -->
        <div class="calendar-header text-danger">SUN</div>
        <div class="calendar-header">MON</div>
        <div class="calendar-header">TUE</div>
        <div class="calendar-header">WED</div>
        <div class="calendar-header">THU</div>
        <div class="calendar-header">FRI</div>
        <div class="calendar-header text-primary">SAT</div>

        {% for day, weekday in days %}
        {% if day > 0 %}
        <div class="calendar-day 
                {% if year == today.year and month == today.month and day == today.day %}day-today{% endif %}
                {% if weekday == 0 %}text-danger{% elif weekday == 6 %}text-primary{% endif %}
                {% if day in events_by_day and events_by_day[day].is_important %}border border-warning border-2 bg-warning bg-opacity-10{% endif %}"
            data-bs-toggle="tooltip" data-bs-placement="top"
            title="{% if day in events_by_day %}{{ events_by_day[day].title }}{% else %}月齢: {{ moon_ages[loop.index0] or '-' }}{% endif %}">

            <a href="{{ url_for('main.moon_detail', year=year, month=month, day=day) }}"
                class="text-decoration-none text-reset d-block h-100 w-100">
                <div class="day-number">{{ day }}</div>

                <div class="moon-info">
                    {% if moon_images[loop.index0] %}
                    <img src="{{ url_for('static', filename=moon_images[loop.index0]) }}" alt="Moon Phase"
                        class="moon-img-sm">
                    <div class="moon-age-text d-none d-md-block">{{ moon_ages[loop.index0] }}</div>
                    {% else %}
                    <div style="height: 32px;"></div>
                    {% endif %}
                </div>

                {% if moon_names[loop.index0] %}
                <div class="text-center mt-1">
                    <span class="badge bg-dark bg-opacity-75 text-white fw-light small">{{ moon_names[loop.index0]
                        }}</span>
                </div>
                {% endif %}

                {% if day in events_by_day %}
                <div class="event-marker">
                    {% if events_by_day[day].is_important %}
                    <i class="fas fa-star text-warning fa-lg"></i>
                    {% else %}
                    <i class="fas fa-circle text-info fa-xs"></i>
                    {% endif %}
                </div>
                {% endif %}
            </a>
        </div>
        {% else %}
        <div class="calendar-day opacity-25" style="background: transparent; border: none;"></div>
        {% endif %}
        {% endfor %}
    </div>

    <!-- Instructions / Legend -->
    <div class="mt-5 text-center small text-secondary">
        <span class="me-3"><i class="fas fa-star text-warning me-1"></i> 特別な天体イベント</span>
        <span><i class="far fa-circle me-1"></i> 日付をクリックで詳細を表示（予定）</span>
    </div>

    <hr class="my-5 opacity-25">

    <!-- Moon Simulator Section -->
    <div class="row justify-content-center mb-5">
        <div class="col-lg-10">
            <div class="card bg-dark border-0 shadow-lg overflow-hidden position-relative moon-simulator-card">
                <div class="card-body p-4 p-md-5 text-center">
                    <h2 class="h3 mb-4 text-primary"><i class="fas fa-moon me-2"></i>月相シミュレーター</h2>
                    <p class="text-secondary mb-5">スライダーを動かして、月の満ち欠けを体験しましょう</p>

                    <div class="moon-display-container my-5">
                        <div class="moon-glow"></div>
                        <img id="simulator-moon" src="{{ url_for('static', filename='images/moon_15.png') }}"
                            alt="Simulated Moon" class="img-fluid simulator-moon-img">
                    </div>

                    <div class="simulator-controls px-md-5">
                        <div class="d-flex justify-content-between mb-2 small text-secondary font-monospace">
                            <span>新月 (0)</span>
                            <span id="current-age-display" class="text-primary h5">月齢: 15.0</span>
                            <span>満月 (15)</span>
                        </div>
                        <input type="range" class="form-range custom-moon-range" id="moon-age-slider" min="0" max="30"
                            step="0.5" value="15">
                        <div class="mt-3 small text-muted">
                            <span id="moon-phase-name">満月の頃</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })

        // Moon Simulator Logic
        const slider = document.getElementById('moon-age-slider');
        const moonImg = document.getElementById('simulator-moon');
        const ageDisplay = document.getElementById('current-age-display');
        const phaseNameDisplay = document.getElementById('moon-phase-name');

        const phaseNames = [
            { max: 1.5, name: "新月 (New Moon)" },
            { max: 6.5, name: "三日月 (Waxing Crescent)" },
            { max: 8.5, name: "上弦の月 (First Quarter)" },
            { max: 13.5, name: "十日余りの月 (Waxing Gibbous)" },
            { max: 16.5, name: "満月 (Full Moon)" },
            { max: 19.5, name: "十六夜月 (Waning Gibbous)" },
            { max: 22.5, name: "寝待月 (Waning Gibbous)" },
            { max: 24.5, name: "下弦の月 (Last Quarter)" },
            { max: 28.5, name: "明けの三日月 (Waning Crescent)" },
            { max: 31, name: "新月 (New Moon)" }
        ];

        // Preload images for smoother sliding
        const preloadImages = () => {
            for (let i = 0; i <= 30; i++) {
                const img = new Image();
                img.src = `/static/images/moon_${i.toString().padStart(2, '0')}.png`;
            }
        };
        // Start preloading after a short delay to prioritize initial page load
        setTimeout(preloadImages, 1000);

        slider.addEventListener('input', function () {
            const age = parseFloat(this.value);
            // Use Math.round for better alignment with integer image names
            const intAge = Math.round(age).toString().padStart(2, '0');

            // Update image
            const newSrc = `/static/images/moon_${intAge}.png`;
            if (moonImg.src !== window.location.origin + newSrc) {
                moonImg.src = newSrc;
            }

            // Update display
            ageDisplay.innerText = `月齢: ${age.toFixed(1)}`;

            // Update name
            const phase = phaseNames.find(p => age < p.max) || phaseNames[phaseNames.length - 1];
            phaseNameDisplay.innerText = phase.name;

            // Subtle visual effect (removed jittery scale)
            moonImg.style.transform = `rotate(${(age - 15) * 1}deg)`;
            moonImg.style.opacity = '1'; 
        });
    });
</script>
{% endblock %}