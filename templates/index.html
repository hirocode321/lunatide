{% extends "base.html" %}

{% block title %}月齢カレンダー{% endblock %}

{% block content %}
<div class="container my-5 calendar-container fade-in">
    <div class="text-center mb-4">
        <h1 class="display-5 font-weight-bold">{{ year }}年{{ month }}月</h1>
        <p class="text-secondary">月齢と星々が織りなす、今月のリズム</p>
        <div class="small text-muted mb-4 d-flex justify-content-center align-items-center">
            <i class="fas fa-location-dot me-2"></i>
            <form action="{{ url_for('main.set_location') }}" method="POST" class="d-inline-block">
                <input type="hidden" name="next" value="{{ request.path }}">
                <select name="prefecture"
                    class="form-select form-select-sm border-0 bg-transparent text-primary fw-bold"
                    style="cursor: pointer; padding-left: 0; box-shadow: none;" onchange="this.form.submit()">
                    {% for pref in all_prefectures %}
                    <option value="{{ pref }}" {% if pref==pref_location %}selected{% endif %}>{{ pref }}</option>
                    {% endfor %}
                </select>
            </form>
        </div>
    </div>

    <!-- Notifications & Recommendations -->
    <div class="row justify-content-center mb-5">
        <div class="col-md-8">
            {% if tomorrow_event %}
            <div class="alert alert-info border-0 shadow-sm d-flex align-items-center mb-3" role="alert">
                <div class="display-6 me-3"><i class="fas fa-bell"></i></div>
                <div>
                    <h5 class="alert-heading mb-1">明日、注目の天体イベントがあります！</h5>
                    <p class="mb-0">{{ tomorrow_event.title }} ({{ tomorrow_event.iso_date }}) - <a
                            href="{{ url_for('astro.astroinfo', event=tomorrow_event.slug) }}"
                            class="alert-link">詳細を見る</a></p>
                </div>
            </div>
            {% endif %}

            {% if recommendation %}
            <div class="card border-0 shadow-lg {{ recommendation.bg_class or 'bg-light text-dark' }} mb-4"
                style="background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); border: 1px solid rgba(255,255,255,0.1) !important;">
                <div class="card-body d-flex align-items-center p-4">
                    <div class="display-4 me-4" style="filter: drop-shadow(0 0 10px currentColor); opacity: 0.9;"><i
                            class="{{ recommendation.icon }}"></i></div>
                    <div>
                        <h5 class="card-title fw-bold mb-1">今日のおすすめ: {{ recommendation.title }}</h5>
                        <p class="card-text mb-0 opacity-90">{{ recommendation.text }}</p>
                        <!-- Visibility Visualization -->
                        <div class="mt-2 text-warning">
                            {% if '星空観測に最適' in recommendation.title %}
                            <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i
                                class="fas fa-star"></i><i class="fas fa-star"></i> <span
                                class="text-white small ms-1">絶好の観測日</span>
                            {% elif '三日月' in recommendation.title or 'クレーター' in recommendation.title %}
                            <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i
                                class="far fa-star"></i><i class="far fa-star"></i>
                            {% else %}
                            <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="far fa-star"></i><i
                                class="far fa-star"></i><i class="far fa-star"></i>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- 気象情報セクション -->
            {% if weather_info %}
            <div class="card bg-dark text-white border-secondary shadow-sm mb-5">
                <div class="card-header border-secondary bg-transparent">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0"><i class="{{ weather_info.icon_class }} me-2"></i>観測ポイント予測 ({{
                            weather_info.time
                            }})</h5>
                        <form action="{{ url_for('main.set_location') }}" method="POST"
                            class="d-flex align-items-center">
                            <input type="hidden" name="next" value="{{ request.path }}">
                            <select name="prefecture"
                                class="form-select form-select-sm bg-dark text-white border-secondary me-2"
                                style="width: auto;" onchange="this.form.submit()">
                                {% for pref in all_prefectures %}
                                <option value="{{ pref }}" {% if pref==pref_location %}selected{% endif %}>{{ pref }}
                                </option>
                                {% endfor %}
                            </select>
                        </form>
                    </div>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <p class="mb-1 text-muted small">天気概況</p>
                            <h4 class="mb-0">{{ weather_info.condition }}</h4>
                        </div>
                        <div class="text-end">
                            <p class="mb-1 text-muted small">雲量</p>
                            <h4 class="mb-0">{{ weather_info.cloud_cover }}%</h4>
                        </div>
                    </div>

                    <div>
                        <p class="mb-2 small text-muted">星空指数 (現在: {{ weather_info.starry_index }}%)</p>
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1 me-3">
                                <div class="progress" style="height: 10px; background-color: #333;">
                                    {% set score_pct = weather_info.starry_index %}
                                    <div class="progress-bar {% if score_pct >= 80 %}bg-success{% elif score_pct >= 50 %}bg-info{% elif score_pct >= 30 %}bg-warning{% else %}bg-danger{% endif %}"
                                        role="progressbar" style="width: {{ score_pct }}%"
                                        aria-valuenow="{{ score_pct }}" aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>
                            </div>
                            <span
                                class="badge {% if score_pct >= 80 %}bg-success{% elif score_pct >= 50 %}bg-info{% elif score_pct >= 30 %}bg-warning{% else %}bg-danger{% endif %} rounded-pill">
                                期待度: {{ score_pct }}%
                            </span>
                        </div>
                    </div>

                    {% if weather_info.suggestion %}
                    <div class="mt-4 p-3 rounded bg-opacity-10 bg-info border border-info border-opacity-25">
                        <p class="mb-0 fw-bold text-info">
                            <i class="fas fa-magic me-2"></i>{{ weather_info.suggestion }}
                        </p>
                    </div>
                    {% endif %}

                    {% if weather_info.hourly %}
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-secondary w-100 border-0 text-muted" type="button"
                            data-bs-toggle="collapse" data-bs-target="#hourlyWeather" aria-expanded="false"
                            aria-controls="hourlyWeather">
                            <i class="fas fa-chevron-down me-1"></i> 今夜の時系列データ (日没〜日の出) を表示
                        </button>
                        <div class="collapse mt-3" id="hourlyWeather">
                            <div class="card card-body bg-dark border-secondary p-0 overflow-hidden"
                                style="max-height: 300px; overflow-y: auto;">
                                <div class="list-group list-group-flush">
                                    {% for h in weather_info.hourly %}
                                    {# 指定日の15時から翌日10時までを表示（夜間を広くカバー） #}
                                    {% if (h.date == weather_info.hourly[0].date and h.hour >= 15) or (h.date !=
                                    weather_info.hourly[0].date and h.hour <= 10) %} <div
                                        class="list-group-item bg-dark text-white border-secondary border-opacity-50 py-2 d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center" style="width: 80px;">
                                            <span
                                                class="small font-monospace {% if h.hour == 21 %}text-primary fw-bold{% else %}text-muted{% endif %}">{{
                                                h.time }}</span>
                                        </div>
                                        <div class="flex-grow-1 px-3 d-flex align-items-center">
                                            <div class="progress w-100" style="height: 6px; background-color: #222;">
                                                <div class="progress-bar {% if h.starry_index >= 80 %}bg-success{% elif h.starry_index >= 50 %}bg-info{% elif h.starry_index >= 30 %}bg-warning{% else %}bg-danger{% endif %}"
                                                    style="width: {{ h.starry_index }}%"></div>
                                            </div>
                                        </div>
                                        <div class="text-end" style="width: 100px;">
                                            <i class="{{ h.icon_class }} small me-2"></i>
                                            <span class="small font-monospace">{{ h.starry_index }}%</span>
                                        </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        <div class="text-center mt-2">
                            <small class="text-muted"><i
                                    class="fas fa-info-circle me-1"></i>指数の詳細は各日の詳細ページでも確認できます。</small>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
</div>

<!-- 星空タイムライン (Starry Sky Timeline) -->
{% if timeline_events %}
<div class="card bg-dark text-white border-secondary shadow-lg mb-5 overflow-hidden">
    <div class="card-header border-secondary bg-transparent py-3">
        <h5 class="card-title mb-0 fw-bold"><i class="fas fa-route text-primary me-2"></i>今日の星空スケジュール</h5>
    </div>
    <div class="card-body p-4 overflow-auto">
        <div class="timeline-horizontal d-flex justify-content-between align-items-start position-relative flex-nowrap"
            style="min-width: 600px;">
            <!-- Connecting Line -->
            <div class="position-absolute w-100 top-0 start-0 mt-3"
                style="height: 3px; background: linear-gradient(90deg, #343a40 0%, #0d6efd 50%, #343a40 100%); z-index: 0; opacity: 0.5;">
            </div>

            {% for event in timeline_events %}
            <div class="timeline-step text-center position-relative px-2" style="z-index: 1; width: min-content;">
                <div class="timeline-icon bg-dark border border-2 {% if event.type == 'night_start' or event.type == 'night_end' %}border-light{% elif event.type == 'iss' %}border-info{% elif event.type == 'moon' or event.type == 'twilight' %}border-warning{% else %}border-secondary{% endif %} rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2 shadow"
                    style="width: 48px; height: 48px; box-shadow: 0 0 10px rgba(0,0,0,0.5);">
                    <i class="{{ event.icon }} fa-lg"></i>
                </div>
                <div class="fw-bold font-monospace text-primary mb-1">{{ event.time }}</div>
                <div class="text-light small" style="font-size: 0.8rem; line-height: 1.3; word-break: keep-all;">{{
                    event.label }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <a href="{{ url_for('main.index', year=prev_year, month=prev_month) }}" class="btn btn-outline-light px-4">
        <i class="fas fa-chevron-left me-2"></i>前月
    </a>
    <div class="h4 mb-0 text-primary font-monospace">{{ year }}.{{ month }}</div>
    <a href="{{ url_for('main.index', year=next_year, month=next_month) }}" class="btn btn-outline-light px-4">
        次月<i class="fas fa-chevron-right ms-2"></i>
    </a>
</div>

<div class="calendar-grid">
    <!-- Weekday Headers -->
    <div class="calendar-header text-danger">SUN</div>
    <div class="calendar-header">MON</div>
    <div class="calendar-header">TUE</div>
    <div class="calendar-header">WED</div>
    <div class="calendar-header">THU</div>
    <div class="calendar-header">FRI</div>
    <div class="calendar-header text-primary">SAT</div>

    {% for day, weekday in days %}
    {% if day > 0 %}
    <div class="calendar-day 
                {% if year == today.year and month == today.month and day == today.day %}day-today{% endif %}
                {% if weekday == 6 %}text-danger{% elif weekday == 5 %}text-primary{% endif %}
                {% if day in events_by_day and events_by_day[day].is_important %}border border-warning border-2 bg-warning bg-opacity-10{% endif %}"
        data-bs-toggle="tooltip" data-bs-placement="top"
        title="{% if day in events_by_day %}{{ events_by_day[day].title }}{% else %}月齢: {{ moon_ages[loop.index0] or '-' }}{% endif %}">

        <a href="{{ url_for('main.moon_detail', year=year, month=month, day=day) }}"
            class="text-decoration-none text-reset d-block h-100 w-100">
            <div class="day-number">{{ day }}</div>

            <div class="moon-info">
                {% if moon_images[loop.index0] %}
                <img src="{{ url_for('static', filename=moon_images[loop.index0]) }}" alt="Moon Phase"
                    class="moon-img-sm">
                <div class="moon-age-text d-none d-md-block">{{ moon_ages[loop.index0] }}</div>
                {% if moon_rises[loop.index0] %}
                <div class="text-secondary mt-1" style="font-size: 0.75rem;">
                    <i class="fas fa-arrow-up fa-xs"></i> {{ moon_rises[loop.index0] }}
                </div>
                {% endif %}
                {% else %}
                <div style="height: 32px;"></div>
                {% endif %}
            </div>

            {% if moon_names[loop.index0] %}
            <div class="text-center mt-1">
                <span class="badge bg-dark bg-opacity-75 text-white fw-light small">{{ moon_names[loop.index0]
                    }}</span>
            </div>
            {% endif %}

            {% if day in events_by_day %}
            <div class="event-marker">
                {% if events_by_day[day].is_important %}
                <i class="fas fa-star text-warning fa-lg"></i>
                {% else %}
                <i class="fas fa-circle text-info fa-xs"></i>
                {% endif %}
            </div>
            {% endif %}

            {% if photo_potential[loop.index0] %}
            <div class="photo-marker" style="position: absolute; top: 5px; right: 5px;">
                <i class="fas fa-camera text-success small" title="星空撮影に最適" data-bs-toggle="tooltip"></i>
            </div>
            {% endif %}
        </a>
    </div>
    {% else %}
    <div class="calendar-day opacity-25" style="background: transparent; border: none;"></div>
    {% endif %}
    {% endfor %}
</div>

<!-- Instructions / Legend -->
<div class="mt-5 text-center small text-secondary">
    <span class="me-3"><i class="fas fa-star text-warning me-1"></i> 特別な天体イベント</span>
    <span class="me-3"><i class="fas fa-camera text-success me-1"></i> 星空撮影の好機</span>
    <span><i class="far fa-circle me-1"></i> 日付をクリックで詳細を表示</span>
</div>

<div class="mt-4 text-center">
    {% set share_url = url_for('main.index', year=year, month=month, _external=True) %}
    {% set share_text = year ~ "年" ~ month ~ "月の月齢カレンダーと天文イベントをチェック！ #LunaTide" %}
    <a href="https://x.com/intent/tweet?text={{ share_text | urlencode }}&url={{ share_url | urlencode }}"
        target="_blank" class="btn btn-x-share rounded-pill px-4">
        <i class="fab fa-x-twitter me-2"></i>今月のカレンダーをシェア
    </a>
</div>

<!-- Monthly Highlights Section -->
{% if db_events %}
<div class="mt-5 pt-4">
    <h3 class="h4 mb-4 border-start border-primary border-4 ps-3">今月の天文ハイライト</h3>
    <div class="row row-cols-1 row-cols-md-2 g-4">
        {% for event in db_events %}
        <div class="col">
            <div class="card h-100 bg-dark border-secondary hover-lift">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <div class="small text-primary font-monospace mb-1">{{ event.iso_date }}</div>
                        <span
                            class="badge mb-1 {% if event.badge == '月食' %}badge-lunar-eclipse{% elif event.badge == '流星群' %}badge-meteor-shower{% elif event.badge == '惑星観測' %}badge-planetary{% elif event.badge == '満月' %}badge-full-moon{% elif event.badge == 'レア現象' %}badge-rare{% else %}bg-secondary{% endif %}">{{
                            event.badge }}</span>
                        <h5 class="h6 mb-0">{{ event.title }}</h5>
                    </div>
                    <a href="{{ url_for('astro.astroinfo', event=event.slug) }}"
                        class="btn btn-sm btn-outline-light rounded-pill px-3">
                        詳細 <i class="fas fa-chevron-right ms-1 small"></i>
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Beginner Guide CTA -->
<div class="mt-5 p-5 bg-dark border-0 shadow-lg rounded-4 text-center position-relative overflow-hidden"
    style="background: linear-gradient(135deg, #1a1f26 0%, #0d1117 100%) !important;">
    <div class="position-absolute translate-middle-y end-0 opacity-10 d-none d-lg-block"
        style="top: 50%; right: -50px; font-size: 200px;">
        <i class="fas fa-camera"></i>
    </div>
    <div class="position-relative">
        <h3 class="h2 text-white mb-3 fw-bold">カメラで夜空を切り取ろう</h3>
        <p class="text-secondary lead mb-4 mx-auto" style="max-width: 600px;">
            初心者でも大丈夫。星を綺麗に撮るための設定やコツ、機材の選び方をガイドにまとめました。
        </p>
        <a href="{{ url_for('guide.index') }}" class="btn btn-primary btn-lg px-5 rounded-pill shadow-sm">
            <i class="fas fa-book-open me-2"></i>撮影ガイドを見る
        </a>
    </div>
</div>

<hr class="my-5 opacity-25">

<!-- Moon Simulator Section -->
<div class="row justify-content-center mb-5">
    <div class="col-lg-10">
        <div class="card bg-dark border-0 shadow-lg overflow-hidden position-relative moon-simulator-card">
            <div class="card-body p-4 p-md-5 text-center">
                <h2 class="h3 mb-4 text-primary"><i class="fas fa-moon me-2"></i>月相シミュレーター</h2>
                <p class="text-secondary mb-5">スライダーを動かして、月の満ち欠けを体験しましょう</p>

                <div class="moon-display-container my-5">
                    <div class="moon-glow"></div>
                    <img id="simulator-moon" src="{{ url_for('static', filename='images/moon_15.png') }}"
                        alt="Simulated Moon" class="img-fluid simulator-moon-img">
                </div>

                <div class="simulator-controls px-md-5">
                    <div class="d-flex justify-content-between mb-2 small text-secondary font-monospace">
                        <span>新月 (0)</span>
                        <span id="current-age-display" class="text-primary h5">月齢: 15.0</span>
                        <span>満月 (15)</span>
                    </div>
                    <input type="range" class="form-range custom-moon-range" id="moon-age-slider" min="0" max="30"
                        step="0.5" value="15">
                    <div class="mt-3 small text-muted">
                        <span id="moon-phase-name">満月の頃</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })

        // Moon Simulator Logic
        const slider = document.getElementById('moon-age-slider');
        const moonImg = document.getElementById('simulator-moon');
        const ageDisplay = document.getElementById('current-age-display');
        const phaseNameDisplay = document.getElementById('moon-phase-name');

        const phaseNames = [
            { max: 1.5, name: "新月 (New Moon)" },
            { max: 6.5, name: "三日月 (Waxing Crescent)" },
            { max: 8.5, name: "上弦の月 (First Quarter)" },
            { max: 13.5, name: "十日余りの月 (Waxing Gibbous)" },
            { max: 16.5, name: "満月 (Full Moon)" },
            { max: 19.5, name: "十六夜月 (Waning Gibbous)" },
            { max: 22.5, name: "寝待月 (Waning Gibbous)" },
            { max: 24.5, name: "下弦の月 (Last Quarter)" },
            { max: 28.5, name: "明けの三日月 (Waning Crescent)" },
            { max: 31, name: "新月 (New Moon)" }
        ];

        // Preload images for smoother sliding
        const preloadImages = () => {
            for (let i = 0; i <= 30; i++) {
                const img = new Image();
                img.src = `/static/images/moon_${i.toString().padStart(2, '0')}.png`;
            }
        };
        // Start preloading after a short delay to prioritize initial page load
        setTimeout(preloadImages, 1000);

        slider.addEventListener('input', function () {
            const age = parseFloat(this.value);
            // Use Math.round for better alignment with integer image names
            const intAge = Math.round(age).toString().padStart(2, '0');

            // Update image
            const newSrc = `/static/images/moon_${intAge}.png`;
            if (moonImg.src !== window.location.origin + newSrc) {
                moonImg.src = newSrc;
            }

            // Update display
            ageDisplay.innerText = `月齢: ${age.toFixed(1)}`;

            // Update name
            const phase = phaseNames.find(p => age < p.max) || phaseNames[phaseNames.length - 1];
            phaseNameDisplay.innerText = phase.name;

            // Subtle visual effect (removed jittery scale)
            moonImg.style.transform = `rotate(${(age - 15) * 1}deg)`;
            moonImg.style.opacity = '1';
        });
    });
</script>
{% endblock %}